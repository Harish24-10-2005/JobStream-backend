# ===========================================
# Backend standalone deployment
# Usage: docker-compose up --build
# ===========================================

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jobai-backend
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    env_file:
      - .env
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - PORT=${PORT:-8000}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      - REDIS_URL=${REDIS_URL:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-8000}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: include Redis if self-hosting
  redis:
    image: redis:7-alpine
    container_name: jobai-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    profiles:
      - with-redis

  # Optional: Celery worker (for browser automation tasks)
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jobai-worker
    command: celery -A src.worker.celery_app worker --loglevel=info --pool=solo
    env_file:
      - .env
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    depends_on:
      - backend
    restart: unless-stopped
    profiles:
      - with-worker
