version: '3.8'

services:
  # ==============================================
  # JobAI Backend API
  # ==============================================
  backend:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: jobai-api
    ports:
      - "8000:10000"
    volumes:
      - .:/app
    environment:
      - ENVIRONMENT=development
      - PHOENIX_COLLECTOR_ENDPOINT=http://phoenix:6006
      - REDIS_URL=redis://redis:6379/0
      # Pass through host credentials
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - SERPAPI_API_KEY=${SERPAPI_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
      phoenix:
        condition: service_started
    command: uvicorn src.main:app --host 0.0.0.0 --port 10000 --reload

  # ==============================================
  # Worker (Celery/Agent Tasks)
  # ==============================================
  # ==============================================
  # Worker (Celery/Agent Tasks)
  # ==============================================
  worker:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: jobai-worker
    command: celery -A src.worker.celery_app worker --loglevel=info --pool=solo
    environment:
      - REDIS_URL=redis://redis:6379/0
      - PHOENIX_COLLECTOR_ENDPOINT=http://phoenix:6006
      # Pass through host credentials for worker
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - SERPAPI_API_KEY=${SERPAPI_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_started

  # ==============================================
  # Redis (Message Broker & Cache)
  # ==============================================
  redis:
    image: redis:7-alpine
    container_name: jobai-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ==============================================
  # Arize Phoenix (LLM Observability)
  # ==============================================
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: jobai-phoenix
    ports:
      - "6006:6006" # UI Port
      - "4317:4317" # OTLP gRPC Receiver
    environment:
      - PHOENIX_PORT=6006
      - PHOENIX_GRPC_PORT=4317
